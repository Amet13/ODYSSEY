name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write

jobs:
  validate-release:
    runs-on: macos-15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version consistency
        run: |
          echo "ğŸ” Validating version consistency..."

          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "Release version: $VERSION"

          # Check project.yml version
          PROJECT_VERSION=$(grep "MARKETING_VERSION:" Config/project.yml | sed 's/.*MARKETING_VERSION: "\(.*\)"/\1/')
          if [ "$PROJECT_VERSION" != "$VERSION" ]; then
            echo "âŒ Version mismatch: tag=$VERSION, project.yml=$PROJECT_VERSION"
            exit 1
          fi

          # Check Info.plist version
          INFO_VERSION=$(grep "CFBundleShortVersionString" Sources/App/Info.plist | sed 's/.*<string>\(.*\)<\/string>.*/\1/')
          if [ "$INFO_VERSION" != "$VERSION" ]; then
            echo "âŒ Version mismatch: tag=$VERSION, Info.plist=$INFO_VERSION"
            exit 1
          fi

          echo "âœ… Version consistency validated"

      - name: Generate changelog
        id: changelog
        run: |
          echo "ğŸ“ Generating changelog..."

          # Get previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s" ${PREVIOUS_TAG}..HEAD | grep -v "Merge pull request" | grep -v "Merge branch")
          else
            CHANGELOG=$(git log --pretty=format:"- %s" HEAD | grep -v "Merge pull request" | grep -v "Merge branch" | head -20)
          fi

          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "âœ… Changelog generated"

  build-release:
    runs-on: macos-15
    needs: validate-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.4"

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
          key: ${{ runner.os }}-swift-${{ hashFiles('**/Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-swift-

      - name: Install dependencies
        run: |
          brew install xcodegen
          brew install create-dmg

      - name: Generate Xcode project
        run: |
          xcodegen --spec Config/project.yml

      - name: Build Release
        run: |
          xcodebuild build \
            -project Config/ODYSSEY.xcodeproj \
            -scheme ODYSSEY \
            -configuration Release \
            -destination 'platform=macOS' \
            -quiet \
            -showBuildTimingSummary

      - name: Build CLI
        run: |
          echo "ğŸ”¨ Building ODYSSEY CLI..."
          swift build --product odyssey-cli --configuration release

          # Get CLI path
          CLI_PATH=$(swift build --product odyssey-cli --configuration release --show-bin-path)/odyssey-cli
          echo "CLI_PATH=$CLI_PATH" >> $GITHUB_ENV

          # Make executable
          chmod +x "$CLI_PATH"

          # Test CLI
          echo "ğŸ§ª Testing CLI..."
          "$CLI_PATH" version

          echo "âœ… CLI built successfully at: $CLI_PATH"

      - name: Code Sign App
        run: |
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "ODYSSEY.app" -type d 2>/dev/null | head -1)
          echo "Code signing app at: $APP_PATH"

          # Remove any existing code signing
          codesign --remove-signature "$APP_PATH" 2>/dev/null || true

          # Sign with ad-hoc signature (no certificate required)
          codesign --force --deep --sign - "$APP_PATH"

          # Verify the signature
          codesign -dv "$APP_PATH"
          echo "Code signing completed"

      - name: Code Sign CLI
        run: |
          echo "ğŸ” Code signing CLI..."

          # Remove any existing code signing
          codesign --remove-signature "$CLI_PATH" 2>/dev/null || true

          # Sign with ad-hoc signature
          codesign --force --deep --sign - "$CLI_PATH"

          # Verify the signature
          codesign -dv "$CLI_PATH"
          echo "âœ… CLI code signing completed"

      - name: Get app path
        id: app-path
        run: |
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "ODYSSEY.app" -type d 2>/dev/null | head -1)
          echo "APP_PATH=$APP_PATH" >> $GITHUB_OUTPUT
          echo "Found app at: $APP_PATH"

      - name: Create CLI Binary
        run: |
          echo "ğŸ“¦ Creating CLI binary..."

          # Copy CLI binary to release directory
          cp "$CLI_PATH" "odyssey-cli"

          # Make executable
          chmod +x "odyssey-cli"

          echo "âœ… CLI binary created: odyssey-cli"

      - name: Create DMG
        run: |
          # Create DMG directory structure
          mkdir -p dmg_temp
          cp -R "${{ steps.app-path.outputs.APP_PATH }}" dmg_temp/

          # Check if app icon exists, if not create a simple one
          ICON_PATH="dmg_temp/ODYSSEY.app/Contents/Resources/AppIcon.icns"
          if [ ! -f "$ICON_PATH" ]; then
            echo "App icon not found, creating DMG without custom icon"
            # Create DMG without custom icon
            create-dmg \
              --volname "ODYSSEY Installer" \
              --window-pos 200 120 \
              --window-size 600 400 \
              --icon-size 100 \
              --icon "ODYSSEY.app" 175 120 \
              --hide-extension "ODYSSEY.app" \
              --app-drop-link 425 120 \
              "ODYSSEY-${{ github.ref_name }}.dmg" \
              "dmg_temp/"
          else
            echo "Using app icon: $ICON_PATH"
            # Create DMG with custom icon
            create-dmg \
              --volname "ODYSSEY Installer" \
              --volicon "$ICON_PATH" \
              --window-pos 200 120 \
              --window-size 600 400 \
              --icon-size 100 \
              --icon "ODYSSEY.app" 175 120 \
              --hide-extension "ODYSSEY.app" \
              --app-drop-link 425 120 \
              "ODYSSEY-${{ github.ref_name }}.dmg" \
              "dmg_temp/"
          fi

      - name: Get sizes
        run: |
          APP_SIZE=$(du -sh "${{ steps.app-path.outputs.APP_PATH }}" | cut -f1)
          DMG_SIZE=$(du -sh "ODYSSEY-${{ github.ref_name }}.dmg" | cut -f1)
          CLI_SIZE=$(du -sh "$CLI_PATH" | cut -f1)
          CLI_BINARY_SIZE=$(du -sh "odyssey-cli" | cut -f1)

          echo "App size: $APP_SIZE"
          echo "DMG size: $DMG_SIZE"
          echo "CLI size: $CLI_SIZE"
          echo "CLI binary size: $CLI_BINARY_SIZE"

          echo "APP_SIZE=$APP_SIZE" >> $GITHUB_ENV
          echo "DMG_SIZE=$DMG_SIZE" >> $GITHUB_ENV
          echo "CLI_SIZE=$CLI_SIZE" >> $GITHUB_ENV
          echo "CLI_BINARY_SIZE=$CLI_BINARY_SIZE" >> $GITHUB_ENV

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: odyssey-installer
          path: ODYSSEY-${{ github.ref_name }}.dmg
          retention-days: 90

      - name: Upload CLI
        uses: actions/upload-artifact@v4
        with:
          name: odyssey-cli
          path: odyssey-cli
          retention-days: 90

  create-release:
    runs-on: macos-15
    needs: build-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download DMG
        uses: actions/download-artifact@v4
        with:
          name: odyssey-installer
          path: .

      - name: Download CLI
        uses: actions/download-artifact@v4
        with:
          name: odyssey-cli
          path: .

      - name: Generate release notes
        id: release-notes
        run: |
          echo "ğŸ“ Generating comprehensive release notes..."

          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}

          # Get previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGES=$(git log --pretty=format:"- %s" ${PREVIOUS_TAG}..HEAD | grep -v "Merge pull request" | grep -v "Merge branch")
          else
            CHANGES=$(git log --pretty=format:"- %s" HEAD | grep -v "Merge pull request" | grep -v "Merge branch" | head -20)
          fi

          # Create release body
          cat > release_body.md << EOF
          ## ODYSSEY $VERSION

          ### ğŸš€ What's New
          - Native macOS menu bar application for Ottawa Recreation reservations
          - **NEW**: Command-line interface (CLI) for remote automation
          - Smart scheduling with 2-day advance booking
          - Modern SwiftUI interface
          - Native WebKit (WKWebView) automation for seamless booking (no ChromeDriver required)
          - Enhanced security, privacy, and performance optimizations
          - Email verification (IMAP and Gmail support)
          - Anti-detection with human-like automation

          ### ğŸ“¦ Installation

          #### GUI Application
          1. Download the DMG file above
          2. Double-click to mount the disk image
          3. Drag ODYSSEY to your Applications folder
          4. **First Launch**: Right-click ODYSSEY in Applications and select "Open"
          5. Click "Open" in the security dialog that appears
          6. The app will appear in your menu bar
          7. **Note**: This is normal for apps not from the App Store

          #### CLI Tool
          1. Download the CLI binary above
          2. Make executable: `chmod +x odyssey-cli`
          3. Export token from GUI: `export ODYSSEY_EXPORT_TOKEN="<token>"`
          4. Run: `./odyssey-cli run`

          ### ğŸ“‹ Requirements
          - macOS 15 or later

          ### ğŸ”§ Features

          #### GUI Application
          - ğŸ–¥ï¸ Native macOS menu bar integration
          - â° Smart scheduling system
          - âš™ï¸ Easy configuration interface
          - ğŸ¤– Native WebKit automation (no ChromeDriver required)
          - ğŸ”„ Multiple configurations
          - ğŸ“Š Real-time status
          - ğŸ“ Built-in logs with emoji indicators
          - ğŸ”’ Secure credential storage (Keychain)
          - ğŸ“§ Automated email verification (IMAP/Gmail)
          - ğŸ›¡ï¸ Anti-detection (human-like automation)
          - ğŸ“… Step-by-step reservation progress
          - ğŸ§¹ Comprehensive error handling and cleanup

          #### CLI Tool
          - ğŸ–¥ï¸ Command-line interface for remote automation
          - âš¡ Parallel execution of multiple reservations
          - ğŸ•¶ï¸ Headless mode (no browser window)
          - ğŸ”„ CI/CD pipeline integration
          - ğŸ“Š Real-time progress tracking
          - ğŸ›¡ï¸ Same WebKit automation as GUI
          - ğŸ”’ Secure token-based configuration
          - ğŸ“ Comprehensive logging and error handling
          - ğŸ“¦ Pre-built binary (no extraction needed)

          ### ğŸ“Š Build Info
          - **App Size**: ${{ env.APP_SIZE }}
          - **Installer Size**: ${{ env.DMG_SIZE }}
          - **CLI Size**: ${{ env.CLI_SIZE }}
          - **CLI Binary Size**: ${{ env.CLI_BINARY_SIZE }}

          ### ğŸ”„ Recent Changes
          $CHANGES

          ### ğŸ› Issues & Support
          - [Report Issues](https://github.com/Amet13/odyssey/issues)

          ### ğŸ”§ Troubleshooting
          **"App is damaged" error?**
          - Right-click the app and select "Open" instead of double-clicking
          - This is normal for apps not from the App Store
          - macOS Gatekeeper protects you from unsigned apps

          **CLI not working?**
          - Ensure you have an export token from the GUI app
          - Check that the CLI is executable: `chmod +x odyssey-cli`
          - Verify your export token: `./odyssey-cli configs`

          **Notarization:**
          - This app is code signed but **not notarized by Apple**. See documentation for details.

          ---
          **Made with â¤ï¸ for the Ottawa sports community**
          EOF

          echo "RELEASE_BODY<<EOF" >> $GITHUB_OUTPUT
          cat release_body.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ODYSSEY-${{ github.ref_name }}.dmg
            odyssey-cli-${{ github.ref_name }}
          name: ODYSSEY ${{ github.ref_name }}
          body: ${{ steps.release-notes.outputs.RELEASE_BODY }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
