name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write

jobs:
  build-release:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "latest-stable"

      - name: Install dependencies
        run: |
          brew install xcodegen
          brew install create-dmg

      - name: Generate Xcode project
        run: |
          xcodegen --spec Config/project.yml

      - name: Build Release
        run: |
          xcodebuild build \
            -project Config/ODYSSEY.xcodeproj \
            -scheme ODYSSEY \
            -configuration Release \
            -destination 'platform=macOS' \
            -quiet

      - name: Code Sign App
        run: |
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "ODYSSEY.app" -type d 2>/dev/null | head -1)
          echo "Code signing app at: $APP_PATH"

          # Remove any existing code signing
          codesign --remove-signature "$APP_PATH" 2>/dev/null || true

          # Sign with ad-hoc signature (no certificate required)
          codesign --force --deep --sign - "$APP_PATH"

          # Verify the signature
          codesign -dv "$APP_PATH"
          echo "Code signing completed"

      - name: Get app path
        id: app-path
        run: |
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "ODYSSEY.app" -type d 2>/dev/null | head -1)
          echo "APP_PATH=$APP_PATH" >> $GITHUB_OUTPUT
          echo "Found app at: $APP_PATH"

      - name: Create DMG
        run: |
          # Create DMG directory structure
          mkdir -p dmg_temp
          cp -R "${{ steps.app-path.outputs.APP_PATH }}" dmg_temp/

          # Check if app icon exists, if not create a simple one
          ICON_PATH="dmg_temp/ODYSSEY.app/Contents/Resources/AppIcon.icns"
          if [ ! -f "$ICON_PATH" ]; then
            echo "App icon not found, creating DMG without custom icon"
            # Create DMG without custom icon
            create-dmg \
              --volname "ODYSSEY Installer" \
              --window-pos 200 120 \
              --window-size 600 400 \
              --icon-size 100 \
              --icon "ODYSSEY.app" 175 120 \
              --hide-extension "ODYSSEY.app" \
              --app-drop-link 425 120 \
              "ODYSSEY-${{ github.ref_name }}.dmg" \
              "dmg_temp/"
          else
            echo "Using app icon: $ICON_PATH"
            # Create DMG with custom icon
            create-dmg \
              --volname "ODYSSEY Installer" \
              --volicon "$ICON_PATH" \
              --window-pos 200 120 \
              --window-size 600 400 \
              --icon-size 100 \
              --icon "ODYSSEY.app" 175 120 \
              --hide-extension "ODYSSEY.app" \
              --app-drop-link 425 120 \
              "ODYSSEY-${{ github.ref_name }}.dmg" \
              "dmg_temp/"
          fi

      - name: Get app size
        run: |
          APP_SIZE=$(du -sh "${{ steps.app-path.outputs.APP_PATH }}" | cut -f1)
          DMG_SIZE=$(du -sh "ODYSSEY-${{ github.ref_name }}.dmg" | cut -f1)
          echo "App size: $APP_SIZE"
          echo "DMG size: $DMG_SIZE"
          echo "APP_SIZE=$APP_SIZE" >> $GITHUB_ENV
          echo "DMG_SIZE=$DMG_SIZE" >> $GITHUB_ENV

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: odyssey-installer
          path: ODYSSEY-${{ github.ref_name }}.dmg
          retention-days: 30

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: ODYSSEY-${{ github.ref_name }}.dmg
          name: ODYSSEY ${{ github.ref_name }}
          body: |
            ## ODYSSEY ${{ github.ref_name }}

            ### ğŸš€ What's New
            - Automated macOS menu bar application for Ottawa Recreation reservations
            - Smart scheduling with 2-day advance booking
            - Modern SwiftUI interface
            - WebKit automation for seamless booking

            ### ğŸ“¦ Installation
            1. Download the DMG file above
            2. Double-click to mount the disk image
            3. Drag ODYSSEY to your Applications folder
            4. **First Launch**: Right-click ODYSSEY in Applications and select "Open"
            5. Click "Open" in the security dialog that appears
            6. The app will appear in your menu bar
            7. **Note**: This is normal for apps not from the App Store

            ### ğŸ“‹ Requirements
            - macOS 12.0 or later

            ### ğŸ”§ Features
            - ğŸ–¥ï¸ Native macOS menu bar integration
            - â° Smart scheduling system
            - âš™ï¸ Easy configuration interface
            - ğŸ¤– Web automation
            - ğŸ“± Modern UI with hover effects
            - ğŸ”„ Multiple configurations
            - ğŸ“Š Real-time status
            - ğŸ“ Built-in logs

            ### ğŸ“Š Build Info
            - **App Size**: ${{ env.APP_SIZE }}
            - **Installer Size**: ${{ env.DMG_SIZE }}

            ### ğŸ› Issues & Support
            - [Report Issues](https://github.com/Amet13/odyssey/issues)
            - [Community Discussion](https://github.com/Amet13/odyssey/discussions)

            ### ğŸ”§ Troubleshooting
            **"App is damaged" error?**
            - Right-click the app and select "Open" instead of double-clicking
            - This is normal for apps not from the App Store
            - macOS Gatekeeper protects you from unsigned apps

            ---
            **Made with â¤ï¸ for the Ottawa sports community**
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
